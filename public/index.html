<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Message Labeler</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background-color: #222;
      color: #eee;
      transition: background-color 0.3s;
      position: relative;
    }

    #box {
      border: 1px solid #444;
      padding: 20px;
      border-radius: 8px;
      min-width: 300px;
      text-align: center;
      font-size: 1.5em;
      background-color: #333;
      transition: transform 0.3s;
    }

    #author {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }

    #author img {
      width: 48px;
      height: 48px;
      border-radius: 24px;
      margin-right: 10px;
    }

    #roles {
      font-size: 0.7em;
      color: #aaa;
      white-space: normal;
      word-break: break-word;
    }

    #controls { margin-top: 20px; }
    #controls > div { margin-top: 5px; }
    #controls > div { display: flex; justify-content: center; }

    .flash-green { background-color: #264d26; }
    .flash-red { background-color: #4d2626; }
    .flash-blue { background-color: #26324d; }

    #helpContainer {
      position: absolute;
      top: 10px;
      right: 10px;
    }

    #helpBtn {
      background: transparent;
      border: 1px solid #eee;
      color: #eee;
      border-radius: 50%;
      width: 28px;
      height: 28px;
      cursor: pointer;
      font-size: 16px;
      line-height: 24px;
      text-align: center;
    }

    #helpMenu {
      display: none;
      position: absolute;
      right: 0;
      top: 40px;
      background-color: #333;
      border: 1px solid #444;
      padding: 10px;
      border-radius: 4px;
      width: 200px;
      font-size: 0.9em;
      text-align: left;
    }

    #helpMenu.show { display: block; }

    #settingsContainer {
      position: absolute;
      top: 10px;
      left: 10px;
    }

    #settingsBtn {
      background: transparent;
      border: 1px solid #eee;
      color: #eee;
      border-radius: 50%;
      width: 28px;
      height: 28px;
      cursor: pointer;
      font-size: 16px;
      line-height: 24px;
      text-align: center;
    }

    #settingsMenu {
      display: none;
      position: absolute;
      left: 0;
      top: 40px;
      background-color: #333;
      border: 1px solid #444;
      padding: 10px;
      border-radius: 4px;
      width: 220px;
      font-size: 0.9em;
      text-align: left;
    }

    #settingsMenu.show { display: block; }
    #settingsMenu div { margin-bottom: 8px; }
  </style>
</head>
  <body>
    <div id="settingsContainer">
      <button id="settingsBtn">⚙</button>
      <div id="settingsMenu">
        <div>Down Arrow: <span id="downValue"></span>m<br><input type="range" id="downSlider" min="5" max="30"></div>
        <div>Up Arrow: <span id="upValue"></span>m<br><input type="range" id="upSlider" min="5" max="30"></div>
      </div>
    </div>
    <div id="helpContainer">
      <button id="helpBtn">?</button>
      <div id="helpMenu">
        <div><b>Unsafe (←)</b> - delete and mark message unsafe</div>
        <div><b>Safe (→)</b> - mark message as safe</div>
        <div class="downHelp"><b>Mute 5m (↓)</b> - mute user for 5 minutes and delete the message</div>
        <div class="upHelp"><b>Mute 15m (↑)</b> - mute user for 15 minutes and delete the message</div>
        <div><b>Jump to Present</b> - skip to most recent message</div>
      </div>
    </div>
    <div id="box">
      <div id="author">
        <img id="avatar" src="" alt="avatar">
        <div>
          <div id="username"></div>
          <div id="displayName" style="font-size:0.9em;color:#bbb"></div>
          <div id="roles"></div>
        </div>
      </div>
      <div id="content">Loading...</div>
    </div>
    <div id="controls">
      <div><button id="mute15Btn">Mute 15m (↑)</button></div>
      <div>
        <button id="unsafeBtn">Unsafe (←)</button>
        <span style="display:inline-block;width:60px"></span>
        <button id="safeBtn">Safe (→)</button>
      </div>
      <div><button id="muteBtn">Mute 5m (↓)</button></div>
      <div style="margin-top:10px"><button id="jumpBtn">Jump to Present</button></div>
    </div>
    <script>
      let current = null;
      let poll = null;

      const DEFAULT_DOWN = 5;
      const DEFAULT_UP = 15;
      let downDuration = parseInt(localStorage.getItem('downDuration')) || DEFAULT_DOWN;
      let upDuration = parseInt(localStorage.getItem('upDuration')) || DEFAULT_UP;

      function updateDurationUI() {
        document.getElementById('downSlider').value = downDuration;
        document.getElementById('upSlider').value = upDuration;
        document.getElementById('downValue').textContent = downDuration;
        document.getElementById('upValue').textContent = upDuration;
        document.getElementById('muteBtn').textContent = `Mute ${downDuration}m (↓)`;
        document.getElementById('mute15Btn').textContent = `Mute ${upDuration}m (↑)`;
        document.querySelector('#helpMenu .downHelp').innerHTML = `<b>Mute ${downDuration}m (↓)</b> - mute user for ${downDuration} minutes and delete the message`;
        document.querySelector('#helpMenu .upHelp').innerHTML = `<b>Mute ${upDuration}m (↑)</b> - mute user for ${upDuration} minutes and delete the message`;
      }

      document.getElementById('downSlider').addEventListener('input', (e) => {
        downDuration = parseInt(e.target.value);
        localStorage.setItem('downDuration', downDuration);
        updateDurationUI();
      });

      document.getElementById('upSlider').addEventListener('input', (e) => {
        upDuration = parseInt(e.target.value);
        localStorage.setItem('upDuration', upDuration);
        updateDurationUI();
      });

      document.getElementById('settingsBtn').onclick = () => {
        document.getElementById('settingsMenu').classList.toggle('show');
      };

      async function getNext(enterDir) {
        if (poll) { clearTimeout(poll); poll = null; }
        try {
          const res = await fetch('/next');
          if (!res.ok) {
            document.getElementById('content').textContent = 'Waiting for more messages...';
            document.getElementById('username').textContent = '';
            document.getElementById('displayName').textContent = '';
            document.getElementById('roles').textContent = '';
            document.getElementById('avatar').src = '';
            current = null;
            poll = setTimeout(() => getNext(enterDir), 3000);
            return;
          }
          current = await res.json();
          const box = document.getElementById('box');
          box.style.transition = 'none';
          if (enterDir) {
            box.style.transform = `translateX(${enterDir === 'right' ? '-100vw' : '100vw'})`;
          }
          void box.offsetWidth;
          box.style.transition = 'transform 0.3s';
          document.getElementById('content').textContent = current.content || '[no content]';
          document.getElementById('username').textContent = current.username || '';
          document.getElementById('displayName').textContent = current.displayName || '';
          document.getElementById('roles').textContent = (current.roles && current.roles.length) ? current.roles.join(', ') : '';
          document.getElementById('avatar').src = current.avatar || '';
          box.style.transform = 'translateX(0)';
        } catch (e) {
          console.error(e);
        }
      }

      async function sendLabel(label, minutes) {
        if (!current) return;
        const payload = { id: current.id, label };
        if (minutes) payload.duration = minutes;
        await fetch('/label', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const box = document.getElementById('box');
        const body = document.body;
        const dir = label === 'safe' ? 'right' : 'left';
        box.style.transform = `translateX(${dir === 'right' ? '100vw' : '-100vw'})`;
        const flash = label === 'safe' ? 'flash-green' : (label === 'mute' || label === 'mute15' ? 'flash-blue' : 'flash-red');
        body.classList.add(flash);
        setTimeout(() => {
          body.classList.remove('flash-green');
          body.classList.remove('flash-red');
          body.classList.remove('flash-blue');
        }, 300);
        current = null;
        setTimeout(() => getNext(dir), 300);
      }

      async function jumpToPresent() {
        const res = await fetch('/jump', { method: 'POST' });
        if (!res.ok) {
          document.getElementById('content').textContent = 'No messages';
          current = null;
          return;
        }
        current = await res.json();
        document.getElementById('content').textContent = current.content || '[no content]';
        document.getElementById('username').textContent = current.username || '';
        document.getElementById('displayName').textContent = current.displayName || '';
        document.getElementById('roles').textContent = (current.roles && current.roles.length) ? current.roles.join(', ') : '';
        document.getElementById('avatar').src = current.avatar || '';
      }

      document.getElementById('unsafeBtn').onclick = () => sendLabel('unsafe');
      document.getElementById('safeBtn').onclick = () => sendLabel('safe');
      document.getElementById('muteBtn').onclick = () => sendLabel('mute', downDuration);
      document.getElementById('mute15Btn').onclick = () => sendLabel('mute15', upDuration);
      document.getElementById('jumpBtn').onclick = () => jumpToPresent();
      document.getElementById('helpBtn').onclick = () => {
        document.getElementById('helpMenu').classList.toggle('show');
      };
      document.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowLeft') sendLabel('unsafe');
        if (e.key === 'ArrowRight') sendLabel('safe');
        if (e.key === 'ArrowDown') sendLabel('mute', downDuration);
        if (e.key === 'ArrowUp') sendLabel('mute15', upDuration);
      });
      updateDurationUI();
      getNext();
    </script>
</body>
</html>
